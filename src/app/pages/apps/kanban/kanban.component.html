<mat-card class="cardWithShadow">
  <mat-card-content>
    <div
      *ngIf="isLoading"
      class="d-flex justify-content-center align-items-center"
      style="height: 200px"
    >
      <mat-spinner></mat-spinner>
    </div>
    <div *ngIf="!isLoading">
      <div class="d-flex justify-content-between m-b-32">
        <div>
          <mat-card-title>Kanban</mat-card-title>
        </div>
        <div class="d-flex gap-5">
          <mat-form-field appearance="outline" class="mt-4">
            <mat-label>Select Board</mat-label>
            <mat-select
              [(value)]="selectedBoardId"
              (selectionChange)="loadTasks(selectedBoardId)"
            >
              <mat-option [value]="null">All Boards</mat-option>
              <mat-option *ngFor="let board of boards" [value]="board.id">
                {{ board.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button
            mat-flat-button
            (click)="openDialog('Add', { type: 'board' })"
            *ngIf="role === '3' || role === '2'"
          >
            Create Board
          </button>
        </div>
      </div>

      <div
        class="board-heading m-b-20 d-flex align-items-center justify-content-between"
      >
        <div>
          <h3 class="f-s-16 f-w-600">
            {{ selectedBoardId === null ? "All Boards" : selectedBoard?.name }}
          </h3>
          @switch(selectedBoard.visibility) { @case ('public') {
          <span class="f-s-12 p-x-8 text-white badge rounded-pill bg-success">
            Public
          </span>
          } @case ('restricted') {
          <span class="f-s-12 p-x-8 text-white badge rounded-pill bg-warning">
            Restricted
          </span>
          } @default {
          <span class="f-s-12 p-x-8 text-white badge rounded-pill bg-error">
            Private
          </span>
          } }
        </div>

        <button mat-icon-button [matMenuTriggerFor]="boardMenu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #boardMenu="matMenu">
          <button
            mat-menu-item
            (click)="openDialog('Edit', { 
                type: 'board', 
                id: selectedBoard.id,
                company_id: selectedBoard.company_id,
                name: selectedBoard.name,
                visibility: selectedBoard.visibility,
                restrictedUsers: selectedBoard.restrictedUsers,
              })"
          >
            <mat-icon>edit</mat-icon>
            <span>Edit</span>
          </button>
          <button
            mat-menu-item
            (click)="deleteBoard(selectedBoardId)"
            [disabled]="selectedBoard.user_id != userId"
          >
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>
      </div>

      <div class="table-responsive">
        <div class="task-list-section" cdkDropListGroup>
          <div
            class="task-list-container"
            *ngFor="let column of selectedBoardColumns; let i = index"
          >
            <div
              class="connect-sorting"
              [ngClass]="{
                'bg-light-primary': i === 0,
                'bg-light-secondary': i === 1,
                'bg-light-warning': i === 2,
                'bg-light-success': i === 3
              }"
            >
              <div class="m-b-16">
                <h5 class="f-s-16 m-b-0 f-w-600">{{ column.name }}</h5>
              </div>
              <div
                [cdkDropListData]="column.tasks"
                cdkDropList
                (cdkDropListDropped)="drop($event, column.id)"
              >
                <mat-card
                  *ngFor="let task of column.tasks"
                  class="cardWithShadow img-task m-b-15 overflow-hidden mb-4 kanban-task-card"
                  cdkDrag
                  (click)="openDialog('Edit', task)"
                >
                  <div
                    class="d-flex align-items-center justify-content-between p-x-12 p-y-10"
                  >
                    <h5 class="f-s-14 f-w-600">{{ task.goal }}</h5>
                    <span class="text-muted f-s-12 m-l-8">[SD-{{ task.id }}]</span>

                    <button
                      class="d-flex align-items-center justify-content-center"
                      mat-icon-button
                      [matMenuTriggerFor]="menu"
                      (click)="$event.stopPropagation()"
                    >
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu
                      #menu="matMenu"
                      xPosition="before"
                      class="cardWithShadow"
                    >
                      <button
                        mat-menu-item
                        (click)="openDialog('Edit', task)"
                        class="d-flex align-items-center"
                      >
                        <div class="d-flex align-items-center gap-8">
                          <i-tabler
                            name="edit"
                            class="icon-20 d-flex"
                          ></i-tabler>
                          Edit
                        </div>
                      </button>
                      <button
                        mat-menu-item
                        (click)="deleteTask(task, selectedBoardId)"
                        class="d-flex align-items-center"
                      >
                        <div class="d-flex align-items-center gap-8">
                          <i-tabler
                            name="trash"
                            class="icon-20 d-flex"
                          ></i-tabler>
                          Delete
                        </div>
                      </button>
                    </mat-menu>
                  </div>
                  <div *ngIf="task.imageUrl">
                    <img
                      [src]="task.imageUrl"
                      alt="{{ task.title }} image"
                      class="w-100"
                      height="106"
                    />
                  </div>
                  <div *ngIf="task.recommendations">
                    <span class="f-s-12 p-x-12 p-y-10 d-block">{{
                      task.recommendations
                    }}</span>
                  </div>
                  <div *ngIf="task.comments">
                    <span class="f-s-12 p-x-12 p-y-10 d-block text-primary">
                      <b>Comments:</b> {{ task.comments }}
                    </span>
                  </div>
                  <div class="d-flex align-items-center gap-4 p-x-12 p-y-6">
                    <i-tabler name="user" class="icon-16 d-flex"></i-tabler>
                    <span class="f-s-12 lh-base">
                      {{
                        task.user?.name
                          ? task.user.name + " " + (task.user.last_name || "")
                          : "Unassigned"
                      }}
                    </span>
                  </div>
                  <div>
                    <div
                      class="d-flex align-items-center justify-content-between p-x-12 p-y-10"
                    >
                      <div class="d-flex align-items-center gap-4">
                        <i-tabler
                          name="calendar"
                          class="icon-16 d-flex"
                        ></i-tabler>
                        <span class="f-s-12 lh-base">{{
                          task.due_date | date: "MM.dd.yyyy"
                        }}</span>
                      </div>
                      @switch(task.priority || task.priorityAssociation?.id) {
                      @case(4) {
                      <span class="rounded f-s-12 p-x-8 text-white bg-primary">
                        {{ task.priorityAssociation?.name || "Low Priority" }}
                      </span>
                      } @case(3) {
                      <span
                        class="rounded f-s-12 p-x-8 text-white bg-secondary"
                      >
                        {{ task.priorityAssociation?.name || "Normal" }}
                      </span>
                      } @case(2) {
                      <span class="rounded f-s-12 p-x-8 text-white bg-warning">
                        {{ task.priorityAssociation?.name || "Important" }}
                      </span>
                      } @case(1) {
                      <span class="rounded f-s-12 p-x-8 text-white bg-error">
                        {{ task.priorityAssociation?.name || "Urgent" }}
                      </span>
                      } @default {
                      <span class="rounded f-s-12 p-x-8 text-white bg-primary">
                        {{ task.priorityAssociation?.name || "Normal" }}
                      </span>
                      } }
                    </div>
                  </div>
                </mat-card>
                <div style="height: 10px"></div>
              </div>
              <button
                mat-stroked-button
                class="w-100 text-start"
                (click)="
                  openDialog('Add', {
                    columnId: column.id,
                    columnName: column.name
                  })
                "
              >
                <mat-icon>add</mat-icon>
                Create Task
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </mat-card-content>
</mat-card>
