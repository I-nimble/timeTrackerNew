<mat-dialog-content class="mat-typography trello-style">
  <div class="image-preview" *ngIf="firstAttachmentImage">
    <img
      [src]="getImageUrl(firstAttachmentImage)"
      alt="Preview"
      class="header-image"
    />
  </div>

  <div class="dialog-header">
    <h2 class="dialog-title">
      <textarea
        class="title-textarea"
        [class.field-error]="!local_data.goal?.trim() && formTouched"
        matInput
        [(ngModel)]="local_data.goal"
        name="goal"
        placeholder="{{
          local_data.type === 'board' ? 'Board Name *' : 'Task Title *'
        }}"
        (blur)="formTouched = true"
      >
      </textarea>
      <mat-error class="f-s-12" *ngIf="!local_data.goal?.trim() && formTouched">
        {{ local_data.type === 'board' ? 'Board Name' : 'Task Title'}} is required
      </mat-error>
    </h2>
    <button mat-icon-button mat-dialog-close class="close-btn">
      <i-tabler name="x" class="icon-20 d-flex"></i-tabler>
    </button>
  </div>

  <div class="properties-row" *ngIf="local_data.type !== 'board'">
    <div class="property-item" *ngIf="!isOrphan">
      <h3 class="property-title">Members <span class="required-asterisk">*</span></h3>
      <mat-form-field appearance="outline" class="w-100">
        <mat-select
          [(ngModel)]="local_data.employee_id"
          name="employee_id"
          required
          [class.field-error]="!local_data.employee_id"
        >
          <mat-option *ngFor="let user of users" [value]="user.id">
            {{ user.name }} {{ user.last_name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="!local_data.employee_id">
          Member is required
        </mat-error>
      </mat-form-field>
    </div>

    <div class="property-item">
      <h3 class="property-title">Priority <span class="required-asterisk">*</span></h3>
      <mat-form-field appearance="outline" class="w-100">
        <mat-select [(ngModel)]="local_data.priority" name="priority" required [class.field-error]="!local_data.priority">
          <mat-option *ngFor="let priority of priorities" [value]="priority.id">
            {{ priority.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="!local_data.priority">
          Priority is required
        </mat-error>
      </mat-form-field>
    </div>

    <div class="property-item">
      <h3 class="property-title">Due Date</h3>
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Pick a date</mat-label>
        <input
          matInput
          [matDatepicker]="picker"
          placeholder="Select a date"
          name="dueDateTime"
          [(ngModel)]="dueDateTime"
          required
        />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
      <mat-form-field appearance="outline" class="w-100 m-t-10">
        <mat-label>Pick a time</mat-label>
        <input 
          matInput 
          [matTimepicker]="timePicker"
          [(ngModel)]="dueDateTime"
          name="dueDateTime"
          [ngModelOptions]="{updateOn: 'blur'}"
          required
          matTimepickerMin="08:00"
          matTimepickerMax="20:00"
        >
        <mat-timepicker #timePicker></mat-timepicker>
        <mat-timepicker-toggle [for]="timePicker" matSuffix></mat-timepicker-toggle>
      </mat-form-field>
    </div>
  </div>

  <div class="dialog-body">
    <div class="left-content">
      <div class="section" *ngIf="local_data.type !== 'board'">
        <h3 class="section-title">Description</h3>
        <div
          class="editor-content custom-description"
          contenteditable="true"
          (input)="onEditorInput()"
          (paste)="onPaste($event)"
          #descriptionEditor
        ></div>
      </div>

      <div class="section" *ngIf="local_data.type !== 'board'">
        <h3 class="section-title">Attachments</h3>
        <input
          #fileInput
          type="file"
          multiple
          (change)="onFileSelected($event)"
          style="display: none"
        />
        <button mat-stroked-button class="w-100" (click)="fileInput.click()">
          <mat-icon>attach_file</mat-icon> Add Attachment
        </button>

        <div class="attachments-grid" *ngIf="attachments.length > 0">
          <div
            *ngFor="let file of attachments; let i = index"
            class="attachment-item"
          >
            <div class="attachment-thumbnail" *ngIf="isImage(file)">
              <img [src]="getImageUrl(file)" alt="Thumbnail" />
            </div>
            <div class="attachment-info" *ngIf="!isImage(file)">
              <mat-icon>insert_drive_file</mat-icon>
            </div>
            <div class="attachment-details">
              <span class="file-name">{{ file.name || file.file_name }}</span>
              <div class="attachment-actions">
                <button
                  mat-icon-button
                  (click)="downloadAttachment(file.s3_filename)"
                >
                  <mat-icon>download</mat-icon>
                </button>
                <button mat-icon-button (click)="removeAttachment(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="right-content">
      <div class="section" *ngIf="local_data.type !== 'board'">
        <h3 class="section-title">Comments & Activity</h3>

        <!-- Comment input -->
        <div class="comment-input-container">
          <mat-form-field appearance="outline" class="w-100">
            <textarea
              matInput
              name="commentText"
              [(ngModel)]="commentText"
              placeholder="Write a comment..."
              rows="2"
            ></textarea>
          </mat-form-field>

          <button
            mat-flat-button
            color="primary"
            (click)="submitComment()"
            [disabled]="!commentText.trim()"
            class="save-btn"
          >
            Save
          </button>
        </div>

        <div class="comment-history" *ngIf="comments.length > 0">
          <div *ngFor="let c of comments.slice().reverse()" class="comment-item bg-secondary">
            <div class="comment-header d-flex justify-between align-center">
              <div class="user-info">
                <span class="user-name">{{ c.user.name }} {{ c.user.last_name }}</span>
                <span class="comment-date">{{ c.createdAt | date:'dd MMM yyyy, hh:mm a' }}</span>
              </div>

              <div *ngIf="c.user_id === userId">
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #menu="matMenu">
                  <button mat-menu-item (click)="startEditingComment(c)">
                    <mat-icon>edit</mat-icon> Edit
                  </button>
                  <button mat-menu-item (click)="deleteComment(c.id)">
                    <mat-icon>delete</mat-icon> Delete
                  </button>
                </mat-menu>
              </div>
            </div>
            <div class="comment-text">{{ c.comment }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar" *ngIf="local_data.type === 'board'">
    <div class="property-section">
      <h3 class="property-title">Visibility</h3>
      <mat-form-field appearance="outline" class="w-100">
        <mat-select
          (selectionChange)="handleVisibilityChange($event)"
          required
          [(value)]="local_data.selectedVisibility"
        >
          <mat-option
            *ngFor="let visibility of visibilities"
            [value]="visibility"
          >
            {{ visibility }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        class="w-100"
        *ngIf="local_data.selectedVisibility === 'restricted'"
      >
        <mat-label>Allowed users</mat-label>
        <mat-select multiple [(value)]="local_data.restrictedUsers" required>
          <mat-option *ngFor="let user of users" [value]="user.id">
            {{ user.name }} {{ user.last_name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions class="dialog-actions">
  <button mat-flat-button (click)="doAction()" class="primary-btn" [disabled]="!isFormValid()">
    {{ action === "Edit" ? "Save" : "Add" }}
  </button>
  <button mat-flat-button (click)="closeDialog()" class="bg-error text-white">
    Cancel
  </button>
</mat-dialog-actions>