<div class="custom-message-composer">
	<!-- Inline Images Preview -->
	<div class="inline-images-preview" *ngIf="inlineImages.length > 0">
		<div class="image-item" *ngFor="let image of inlineImages">
			<img [src]="image.dataUrl" [alt]="'Inline image'" class="preview-image" />
			<button 
				mat-icon-button 
				class="remove-image-btn"
				(click)="removeImage(image.id)"
				matTooltip="Remove image"
			>
				<mat-icon>close</mat-icon>
			</button>
		</div>
	</div>

	<!-- Text Input Area (Top Section) -->
	<div 
		class="text-input-section"
		(dragover)="handleDragOver($event)"
		(dragleave)="handleDragLeave($event)"
		(drop)="handleDrop($event)"
	>
		<textarea
			#textArea
			class="message-textarea"
			[placeholder]="inlineImages.length > 0 ? 'Add a message...' : 'Enter your message here'"
			[value]="messageText"
			(input)="onTextChange($event)"
			(keydown)="onKeyDown($event)"
			(focus)="onFocus()"
			(blur)="onBlur()"
			rows="1"
			autosize
		></textarea>
		<!-- Drag Overlay -->
		<div class="drag-overlay" *ngIf="isDragOver">
			<mat-icon>cloud_upload</mat-icon>
			<span>Drop image here</span>
		</div>
	</div>

	<!-- Action Buttons Section (Bottom Section) -->
	<div class="action-buttons-section">
		<!-- Left Side - Attachment Button with Dropdown -->
		<div class="attachment-dropdown-container">
			<button 
				mat-icon-button 
				class="attachment-btn"
				(click)="toggleAttachmentDropdown()"
				matTooltip="Add to Chat"
			>
				<img src="assets/images/svgs/Plus.svg" alt="Add attachment" class="icon" />
			</button>
			<!-- Attachment Dropdown -->
			<div class="attachment-dropdown" *ngIf="showAttachmentDropdown">
				<div class="dropdown-item" (click)="selectAttachmentType('image')">
					<img src="assets/images/svgs/photolibrary.svg" alt="Image" class="dropdown-icon" />
					<span>Image</span>
				</div>
				<div class="dropdown-item" (click)="selectAttachmentType('video')">
					<img src="assets/images/svgs/video.svg" alt="Video" class="dropdown-icon" />
					<span>Video</span>
				</div>
				<div class="dropdown-item" (click)="selectAttachmentType('audio')">
					<img src="assets/images/svgs/audio-file.svg" alt="Audio" class="dropdown-icon" />
					<span>Audio</span>
				</div>
				<div class="dropdown-item" (click)="selectAttachmentType('file')">
					<img src="assets/images/svgs/attachment-file.svg" alt="File" class="dropdown-icon" />
					<span>File</span>
				</div>
			</div>
		</div>

		<!-- Right Side - Action Buttons -->
		<div class="right-buttons">
			<!-- Emoji Button with Dropdown -->
			<div class="emoji-dropdown-container">
				<button 
					mat-icon-button 
					class="emoji-btn"
					(click)="toggleEmojiDropdown()"
					matTooltip="Emoji"
				>
					<img src="assets/images/svgs/emoji.svg" alt="Emoji" class="icon" />
				</button>
				<!-- Emoji Dropdown -->
				<div class="emoji-dropdown" *ngIf="showEmojiDropdown">
					<div class="emoji-dropdown-content" style="max-height: 260px; overflow-y: auto; scroll-behavior: smooth; width: max-content;">
						<ng-container *ngFor="let category of emojiCategories">
							<div class="emoji-category-label" [id]="'emoji-cat-' + category.position" style="font-weight: 600; margin: 8px 0 4px 8px; display: flex; align-items: center;">
								{{ category.label }}
							</div>
							<div class="emoji-grid">
								<div 
									class="emoji-item" 
									*ngFor="let emoji of category.emojis" 
									(click)="selectEmoji(emoji)"
									[title]="emoji"
								>
									{{ emoji }}
								</div>
							</div>
						</ng-container>
					</div>
					<!-- Category Icons Row -->
					<div class="emoji-category-icons-row" style="display: flex; justify-content: center; align-items: center; gap: 10px; padding: 8px 0 4px 0; border-top: 1px solid #eee; background: #fafafa;">
						<ng-container *ngFor="let category of emojiCategories">
							<button type="button" class="emoji-category-icon-btn" style="background: none; border: none; cursor: pointer; padding: 0;" (click)="scrollToCategory(category.position)">
								<img [src]="'assets/images/svgs/' + category.icon" [alt]="category.label" style="width: 24px; height: 24px;" />
							</button>
						</ng-container>
					</div>
				</div>
			</div>

			<!-- Voice Recording Button as Dropdown -->
			<div class="voice-recorder-dropdown-container">
				<button 
					*ngIf="!hideVoiceRecording"
					mat-icon-button 
					class="voice-btn"
					(click)="toggleVoiceRecorderDropdown()"
					matTooltip="Voice message"
				>
					<img src="assets/images/svgs/mic.svg" alt="Voice recording" class="icon" />
				</button>
				<div class="voice-recorder-dropdown" *ngIf="showVoiceRecorderDropdown">
					<div class="voice-recorder-dropdown-content">
						<!-- Initial state: show record icon -->
						<ng-container *ngIf="!isRecording && !recordedAudioUrl">
						    <div class="voice-recorder-timer">{{ voiceRecorderTime }}</div>
							<button class="voice-recorder-record-btn" (click)="startVoiceRecording()">
								<img src="assets/images/svgs/record-icon.svg" alt="Record" style="width:20px;height:20px;" />
							</button>
						</ng-container>
						<!-- Recording state: show timer, stop icon -->
						<ng-container *ngIf="isRecording">
						    <div class="voice-recorder-timer">{{ voiceRecorderTime }}</div>
							<div class="voice-recorder-actions">
                                <button class="voice-recorder-close-btn" (click)="discardVoiceRecording()">
									<img src="assets/images/svgs/close.svg" alt="Close" style="width:20px;height:20px;" />
								</button>
								<button class="voice-recorder-stop-btn" (click)="stopVoiceRecording()">
									<img src="assets/images/svgs/stop.svg" alt="Stop" style="width:20px;height:20px;" />
								</button>
							</div>
						</ng-container>
						<!-- Recorded state: show audio controls, send and close icons -->
						<ng-container *ngIf="recordedAudioUrl && !isRecording">
							<div class="voice-recorder-audio-preview">
								<button class="voice-recorder-close-btn" (click)="discardVoiceRecording()">
									<img src="assets/images/svgs/close.svg" alt="Close" style="width:20px;height:20px;" />
								</button>
								<audio [src]="recordedAudioUrl" controls style="margin:0 12px;max-width:220px;"></audio>
								<button class="voice-recorder-send-btn" (click)="sendVoiceRecording()">
									<img src="assets/images/svgs/Send.svg" alt="Send" style="width:20px;height:20px;" />
								</button>
							</div>
						</ng-container>
					</div>
				</div>
			</div>

			<!-- Send Button -->
			<button 
				mat-icon-button 
				class="send-btn"
				[disabled]="!messageText.trim() && inlineImages.length === 0"
				(click)="sendMessage()"
				matTooltip="Send message"
			>
				<img src="assets/images/svgs/Send.svg" alt="Send" class="icon" />
			</button>
		</div>
	</div>

	<!-- Hidden File Inputs -->
	<input 
		#imageInput
		type="file" 
		accept="image/*" 
		style="display: none;" 
		(change)="onFileSelected($event)"
	/>
	<input 
		#videoInput
		type="file" 
		accept="video/*" 
		style="display: none;" 
		(change)="onFileSelected($event)"
	/>
	<input 
		#audioInput
		type="file" 
		accept="audio/*" 
		style="display: none;" 
		(change)="onFileSelected($event)"
	/>
	<input 
		#fileInput
		type="file" 
		accept="*/*" 
		style="display: none;" 
		(change)="onFileSelected($event)"
	/>
</div>
