<ng-template #loaderElement>
  <mat-card class="cardWithShadow">
    <mat-card-content>
      <div class="d-flex justify-content-center align-items-center">
        <app-loader
          [loader]="loader"
          [message]="message"
          [diameter]="44"
        ></app-loader>
      </div>
    </mat-card-content>
  </mat-card>
</ng-template>
<mat-card
  class="cardWithShadow"
  *ngIf="pendingChanges().length > 0"
>
  <mat-card-content>
    <div class="header-row mb-4">
      <div class="left-ghost"></div>
      <h4 class="header-title">Pending Changes</h4>
      <div class="action-buttons">
        <button mat-flat-button color="primary" (click)="approveChanges()">
          Approve
        </button>
        <button
          mat-flat-button
          class="bg-error text-white"
          (click)="rejectChanges()"
        >
          Reject
        </button>
      </div>
    </div>
    <div class="p-16">
      <div class="table-responsive">
        <table
          mat-table
          [dataSource]="pendingChanges()"
          class="mat-mdc-table mdc-data-table__table cdk-table w-100"
          role="table"
        >
          <ng-container matColumnDef="field">
            <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14">
              Field
            </th>
            <td mat-cell *matCellDef="let element" class="f-s-14">
              {{ element.field }}
            </td>
          </ng-container>
          <ng-container matColumnDef="value">
            <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14">
              Updated Info
            </th>
            <td mat-cell *matCellDef="let element" class="f-s-14">
              {{ element.value }}
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="['field', 'value']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['field', 'value']"></tr>
        </table>
      </div>
    </div>
  </mat-card-content>
</mat-card>
<div *ngIf="loader.complete || candidate(); else loaderElement">
  <mat-card class="cardWithShadow" id="candidate-view">
    <mat-card-content>
      <div class="container">
        <div class="header-row mb-4">
          <div class="left-ghost"></div>
          <h4 class="header-title">TALENT MATCH</h4>
          <div class="action-buttons" *ngIf="userRole !== '3' && canEdit">
            <button
              mat-flat-button
              color="primary"
              *ngIf="!editMode"
              (click)="enterEditMode()"
            >
              Edit
            </button>
            <ng-container *ngIf="editMode">
              <button
                mat-flat-button
                color="primary"
                (click)="save()"
                [disabled]="form.invalid || !form.dirty"
              >
                Save
              </button>
              <button
                mat-flat-button
                class="bg-error text-white"
                (click)="cancelEdit()"
              >
                Cancel
              </button>
            </ng-container>
          </div>
        </div>
        <table class="table table-bordered w-100 mb-4">
          <tr>
            <td>
              <b>Name <span class="text-danger" *ngIf="editMode">*</span></b>
            </td>
            <td *ngIf="!editMode">{{ (candidate()?.name | formatName) || "" }}</td>
            <td *ngIf="editMode">
              <input matInput [formControl]="f['name']" />
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="f['name'].hasError('required')"
              >
                Name is required.
              </p>
            </td>
          </tr>

          <tr>
            <td><b>Description</b></td>
            <td *ngIf="!editMode">
              <div *ngIf="candidate()?.description; else noDescription">
                {{ candidate()?.description }}
              </div>
              <ng-template #noDescription>
                <span class="text-muted">No description provided</span>
              </ng-template>
            </td>
            <td *ngIf="editMode">
              <div class="d-flex flex-column gap-2">
                <div class="description-base-text m-b-8">
                  {{ descriptionBaseText }}
                </div>
                <mat-select
                  [formControl]="f['descriptionOption']"
                  placeholder="Select match type"
                >
                  <mat-option
                    *ngFor="let option of descriptionOptions"
                    [value]="option"
                  >
                    {{ option }}
                  </mat-option>
                </mat-select>
              </div>
            </td>
          </tr>

          <tr>
            <td>
              <b>Talent Match Profile Summary <span class="text-danger" *ngIf="editMode">*</span></b>
            </td>
            <td *ngIf="!editMode">{{ candidate()?.talent_match_profile_summary || "" }}</td>
            <td *ngIf="editMode">
              <textarea matInput [formControl]="f['talent_match_profile_summary']"></textarea>
            </td>
          </tr>
          <tr>
            <td>
              <b>Profile Summary</b>
            </td>
            <td *ngIf="!editMode">{{ candidate()?.profile_summary || "" }}</td>
            <td *ngIf="editMode">
              <textarea matInput [formControl]="f['profile_summary']"></textarea>
            </td>
          </tr>
          <tr *ngIf="!isCreateMode">
            <td><b>Negotiator Profile</b></td>
            <td *ngIf="!editMode" colspan="2">
              <div *ngFor="let score of matchScores">
                {{ getCategoryName(score) }}:
                {{ score.match_percentage | number: "1.2-2" }}%
              </div>
              <div *ngIf="matchScores.length === 0" class="text-muted">
                No match percentages set
              </div>
            </td>
            <td *ngIf="editMode && userRole !== '3'" colspan="2">
              <div class="d-flex align-items-center gap-2 mb-2">
                <button
                  mat-stroked-button
                  color="primary"
                  [disabled]="isCreateMode"
                  (click)="
                    openMatchPercentagesModal(); $event.stopPropagation()
                  "
                  type="button"
                >
                  <mat-icon>percent</mat-icon>
                  Edit Match Percentages
                </button>
              </div>

              <div class="current-scores mt-3" *ngIf="matchScores.length > 0">
                <h6 class="mb-2">Current Scores:</h6>
                <div
                  *ngFor="let score of matchScores"
                  class="d-flex align-items-center gap-2 mb-1"
                >
                  <span class="text-dark">{{ getCategoryName(score) }}</span>
                  <span class="fw-bold"
                    >{{ score.match_percentage | number: "1.2-2" }}%</span
                  >
                </div>
              </div>
              <div class="d-none">
                <div *ngFor="let score of matchScores">
                  <ng-container *ngIf="f['matchScores_' + score.id]">
                    <input
                      type="number"
                      matInput
                      [formControl]="f['matchScores_' + score.id]"
                    />
                  </ng-container>
                </div>
              </div>
            </td>
          </tr>
          <tr *ngIf="userRole !== '3' && !isCreateMode">
            <td><b>DISC Profile</b></td>
            <td *ngIf="!editMode">
              <div
                class="disc-badges"
                *ngIf="candidate()?.disc_profiles?.length > 0; else noDisc"
              >
                <span
                  *ngFor="let profile of candidate()?.disc_profiles"
                  class="disc-badge"
                  [style.background-color]="getDiscProfileColor(profile.name)"
                  [title]="profile.description"
                >
                  {{ profile.name.charAt(0) }}
                </span>
                <span class="disc-names m-l-8">
                  {{ getDiscProfileNames(candidate()?.disc_profiles) }}
                </span>
              </div>
              <ng-template #noDisc>
                <span class="text-muted">No DISC profiles assigned</span>
              </ng-template>
            </td>
            <td *ngIf="editMode">
              <div class="d-flex align-items-center gap-2">
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="
                    openMatchPercentagesModal(); $event.stopPropagation()
                  "
                  type="button"
                >
                  <mat-icon>psychology</mat-icon>
                  Edit DISC Profiles
                </button>
                <div
                  class="disc-badges m-l-8"
                  *ngIf="candidate()?.disc_profiles?.length > 0"
                >
                  <span
                    *ngFor="let profile of candidate()?.disc_profiles"
                    class="disc-badge"
                    [style.background-color]="getDiscProfileColor(profile.name)"
                  >
                    {{ profile.name.charAt(0) }}
                  </span>
                </div>
              </div>
            </td>
          </tr>
        </table>

        <h4>RESUMES</h4>
        <table class="table table-bordered w-100">
          <tr *ngIf="userRole !== '3'">
            <td>
              <b>Ranking <span class="text-danger" *ngIf="editMode">*</span></b>
            </td>
            <td *ngIf="!editMode">
              {{ getRankingName(candidate()?.ranking_id) }}
            </td>
            <td *ngIf="editMode">
              <mat-select
                [formControl]="f['ranking_id']"
                placeholder="Select ranking"
              >
                <mat-option
                  *ngFor="let profile of rankingProfiles"
                  [value]="profile.id"
                >
                  {{ profile.ranking }}
                </mat-option>
              </mat-select>
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="f['ranking_id'].hasError('required')"
              >
                Ranking is required.
              </p>
            </td>
          </tr>

          <tr>
            <td><b>Profile Observation</b></td>
            <td *ngIf="!editMode">
              {{ getProfileObservation(candidate()?.ranking_id) }}
            </td>
            <td *ngIf="editMode">
              <mat-select
                [formControl]="f['profile_observation']"
                placeholder="Select profile observation"
              >
                <mat-option
                  *ngFor="let profile of rankingProfiles"
                  [value]="profile.profile_observation"
                >
                  {{ profile.profile_observation }}
                </mat-option>
              </mat-select>
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Position <span class="text-danger" *ngIf="editMode">*</span></b>
            <td *ngIf="!editMode">
              <span class="d-flex align-items-center">
                <span>{{ getPositionTitle(candidate()?.position_id) }}</span>
                <span
                  class="disc-badges"
                  *ngIf="
                    getPositionById(candidate()?.position_id)?.disc_profiles
                      ?.length
                  "
                  style="margin-left: 8px"
                  >(<span
                    *ngFor="
                      let profile of getPositionById(candidate()?.position_id)
                        .disc_profiles
                    "
                    class="disc-badge-small"
                    [style.background-color]="getDiscProfileColor(profile.name)"
                    [title]="profile.name"
                    >{{ profile.name.charAt(0) }}</span
                  >)</span
                >
              </span>
            </td>
            <td *ngIf="editMode">
              <mat-select [formControl]="f['position_id']">
                <mat-option *ngFor="let pos of positions" [value]="pos.id">
                  <span class="d-flex align-items-center">
                    <span>{{ pos.title }}</span>
                    <span
                      class="disc-badges m-l-8"
                      *ngIf="pos.disc_profiles?.length"
                      style="margin-left: 8px"
                      >(<span
                        *ngFor="let profile of pos.disc_profiles"
                        class="disc-badge-small"
                        [style.background-color]="
                          getDiscProfileColor(profile.name)
                        "
                        [title]="profile.name"
                      >
                        {{ profile.name.charAt(0) }} </span
                      >)</span
                    >
                  </span>
                </mat-option>
              </mat-select>
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="f['position_id'].hasError('required')"
              >
                Position is required.
              </p>
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Picture</b></td>
            <td *ngIf="!editMode">
              <div *ngIf="candidate()?.picture || candidate()?.profile_pic_url">
                <a
                  [href]="candidate()?.profile_pic_url || candidate()?.picture"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {{ candidate()?.picture || candidate()?.profile_pic_url }}
                </a>
              </div>
              <span
                *ngIf="!(candidate()?.picture || candidate()?.profile_pic_url)"
                class="text-muted"
              >
                No picture URL provided
              </span>
            </td>
            <td *ngIf="editMode">
              <div class="d-flex flex-column gap-2">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <input
                    #picInput
                    type="file"
                    accept="image/jpeg, image/jpg, image/png"
                    (change)="onProfilePicSelected($event)"
                    style="display: none"
                  />
                  <button
                    mat-stroked-button
                    color="primary"
                    (click)="picInput.click()"
                    type="button"
                  >
                    <mat-icon>upload</mat-icon>
                    Upload Picture
                  </button>
                  <div *ngIf="!selectedProfilePicFile" class="mt-1">
                    <small class="text-muted"
                      >Allowed JPG, PNG. Max size of 1MB</small
                    >
                  </div>
                  <div *ngIf="selectedProfilePicFile" class="mt-1">
                    <small class="text-muted"
                      >Selected: {{ selectedProfilePicFile.name }}</small
                    >
                  </div>
                </div>
              </div>
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Resume</b></td>
            <td *ngIf="!editMode">
              <a
                *ngIf="resumeLink"
                [href]="resumeLink"
                target="_blank"
                rel="noopener noreferrer"
              >
                {{ resumeLink }}
              </a>
              <span *ngIf="!resumeLink" class="text-muted"
                >No resume provided</span
              >
            </td>
            <td *ngIf="editMode">
              <div class="d-flex flex-column gap-2">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <input
                    #resumeInput
                    type="file"
                    accept=".doc, .docx, .pdf"
                    (change)="onResumeSelected($event)"
                    style="display: none"
                  />
                  <button
                    mat-stroked-button
                    color="primary"
                    (click)="resumeInput.click()"
                    type="button"
                  >
                    <mat-icon>upload</mat-icon>
                    Upload Resume
                  </button>
                  <div *ngIf="!selectedResumeFile" class="mt-1">
                    <small class="text-muted"
                      >Allowed PDF, DOC, DOCX. Max size of 1MB</small
                    >
                  </div>
                  <div *ngIf="selectedResumeFile" class="mt-1">
                    <small class="text-muted"
                      >Selected: {{ selectedResumeFile.name }}</small
                    >
                  </div>
                </div>
              </div>
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Interview</b></td>
            <td *ngIf="!editMode">
              <a
                *ngIf="candidate()?.interview_link"
                [href]="getSafeLink(candidate()?.interview_link)"
                target="_blank"
                rel="noopener noreferrer"
              >
                {{ candidate()?.interview_link }}
              </a>
            </td>
            <td *ngIf="editMode">
              <input matInput type="text" [formControl]="f['interview_link']" />
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Hobbies</b></td>
            <td *ngIf="!editMode">{{ candidate()?.hobbies || "" }}</td>
            <td *ngIf="editMode">
              <textarea matInput [formControl]="f['hobbies']"></textarea>
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Work Experience</b></td>
            <td *ngIf="!editMode">
              <div *ngIf="candidate()?.work_experience; else emptyWork">
                <ng-container
                  *ngIf="
                    !showFullWorkExperience &&
                    candidate()?.work_experience?.length > 200
                  "
                >
                  {{ candidate()?.work_experience | slice: 0 : 200 }}...
                  <button
                    mat-button
                    color="primary"
                    class="p-0"
                    (click)="showFullWorkExperience = true"
                  >
                    Read more
                  </button>
                </ng-container>
                <ng-container
                  *ngIf="
                    showFullWorkExperience ||
                    candidate()?.work_experience?.length <= 200
                  "
                >
                  <div
                    *ngFor="
                      let line of breakLines(candidate()?.work_experience)
                    "
                  >
                    {{ line }}
                  </div>
                  <button
                    *ngIf="candidate()?.work_experience?.length > 200"
                    mat-button
                    color="primary"
                    class="p-0"
                    (click)="showFullWorkExperience = false"
                  >
                    Show less
                  </button>
                </ng-container>
              </div>
              <ng-template #emptyWork></ng-template>
            </td>
            <td *ngIf="editMode">
              <textarea
                matInput
                [formControl]="f['work_experience']"
                maxLength="1000"
              ></textarea>
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="f['work_experience'].hasError('maxlength')"
              >
                Text is too long. Please reduce your description from
                {{ f["work_experience"]?.value.length }} to 1000 characters.
              </p>
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Summary Experience <span class="text-danger" *ngIf="editMode">*</span></b></td>
            <td *ngIf="!editMode">
              <div *ngIf="candidate()?.work_experience_summary; else emptySummary">
                {{ candidate()?.work_experience_summary }}
              </div>
              <ng-template #emptySummary>
                <span class="text-muted">No summary provided</span>
              </ng-template>
            </td>
            <td *ngIf="editMode">
              <textarea
                matInput
                [formControl]="f['work_experience_summary']"
                placeholder="Brief summary of work experience (max 200 characters)"
                maxLength="200"
                rows="3"
              ></textarea>
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="f['work_experience_summary'].hasError('maxlength')"
              >
                Summary is too long. Please reduce to 200 characters.
              </p>
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="f['work_experience_summary'].hasError('required')"
              >
                Summary experience is required.
              </p>
              <div class="text-muted f-s-12 m-t-4">
                {{ f['work_experience_summary']?.value?.length || 0 }}/200 characters
              </div>
            </td>
          </tr>

          <tr>
            <td>
              <b>Skills <span class="text-danger" *ngIf="editMode">*</span></b>
            </td>
            <td *ngIf="!editMode">{{ candidate()?.skills || "" }}</td>
            <td *ngIf="editMode">
              <textarea matInput [formControl]="f['skills']"></textarea>
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="f['skills'].hasError('required')"
              >
                Skills are required.
              </p>
            </td>
          </tr>

          <tr>
            <td><b>Trainings</b></td>
            <td>
              <ng-container *ngIf="certifications.length > 0; else noCertifications">
                <div
                  class="m-b-12"
                  *ngFor="let cert of certifications"
                >
                  <div class="p-16">
                    <div class="d-flex align-items-start justify-content-between">
                      <div class="flex-grow-1">
                        <div class="f-w-600 f-s-14 text-primary" *ngIf="cert.name">
                          {{ cert.name }}
                        </div>
                        <div class="f-s-12 text-muted" *ngIf="cert.issuer">
                          Issuer: {{ cert.issuer }}
                        </div>
                        <div class="f-s-12 text-muted" *ngIf="cert.date || cert.expiration_date">
                          <span *ngIf="cert.date">
                            {{ cert.date | date:'MMM yyyy' }}
                          </span>
                          <span *ngIf="cert.date && cert.expiration_date"> - </span>
                          <span *ngIf="cert.expiration_date">
                            {{ cert.expiration_date | date:'MMM yyyy' }}
                          </span>
                        </div>
                        <div class="m-t-8" *ngIf="cert.attachment_url">
                          <div *ngIf="isImage(cert.attachment_url)">
                            <img
                              [src]="getAttachmentUrl(cert.attachment_url)"
                              alt="Certification attachment"
                              class="rounded"
                              style="max-width: 140px; height: auto;"
                            />
                          </div>
                          <div *ngIf="!isImage(cert.attachment_url)">
                            <a
                              [href]="getAttachmentUrl(cert.attachment_url)"
                              target="_blank"
                              rel="noopener noreferrer"
                              class="d-inline-flex align-items-center"
                            >
                              {{ getFileName(cert.attachment_url) }}
                            </a>
                          </div>
                        </div>
                        <div class="m-t-8" *ngIf="cert.url">
                          <a
                            [href]="cert.url"
                            target="_blank"
                            rel="noopener noreferrer"
                          >
                            See credential
                          </a>
                        </div>
                      </div>
                      <div *ngIf="(canEdit || canManage) && (editMode || isCreateMode)">
                        <button mat-icon-button [matMenuTriggerFor]="certActions">
                          <mat-icon>more_vert</mat-icon>
                        </button>
                        <mat-menu #certActions="matMenu">
                          <button mat-menu-item (click)="editCertification(cert)">
                            <mat-icon>edit</mat-icon>
                            <span>Edit</span>
                          </button>
                          <button mat-menu-item (click)="deleteCertification(cert)">
                            <mat-icon>delete</mat-icon>
                            <span>Delete</span>
                          </button>
                        </mat-menu>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
              <ng-template #noCertifications>
                <span class="text-muted">No trainings</span>
              </ng-template>
              <div class="m-t-12" *ngIf="(canEdit || canManage) && (editMode || isCreateMode)">
                <button
                  mat-raised-button
                  color="primary"
                  (click)="addCertification()"
                  [disabled]="isCreateMode"
                >
                  Add Certification
                </button>
                <div class="text-muted f-s-12 m-t-4" *ngIf="isCreateMode">
                  Save the candidate before adding certifications.
                </div>
              </div>
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Education</b></td>
            <td *ngIf="!editMode">
              <div *ngIf="candidate()?.education_history; else emptyEdu">
                <div
                  *ngFor="
                    let line of breakLines(candidate()?.education_history)
                  "
                >
                  {{ line }}
                </div>
              </div>
              <ng-template #emptyEdu></ng-template>
            </td>
            <td *ngIf="editMode">
              <textarea
                matInput
                [formControl]="f['education_history']"
              ></textarea>
            </td>
          </tr>

          <tr *ngIf="userRole !== '3'">
            <td><b>Inimble Academy</b></td>
            <td *ngIf="!editMode">{{ candidate()?.inimble_academy || "" }}</td>
            <td *ngIf="editMode">
              <input matInput [formControl]="f['inimble_academy']" />
            </td>
          </tr>

          <tr>
            <td>
              <b
                >English Level
                <span class="text-danger" *ngIf="editMode">*</span></b
              >
            </td>
            <td *ngIf="!editMode">
              {{ formatEnglishLevelDisplay(candidate()?.english_level) || "" }}
            </td>
            <td *ngIf="editMode">
              <mat-slider
                [style.width]="'calc(100% - 1rem)'"
                min="1"
                max="10"
                step="0.1"
                discrete
              >
                <input matSliderThumb [formControl]="f['english_level']" />
              </mat-slider>
              <div class="m-t-4">
                {{ formatEnglishLevelDisplay(f['english_level']?.value) }}
              </div>
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="f['english_level'].hasError('required')"
              >
                English level is required.
              </p>
              <p
                class="text-danger f-s-12 m-t-0"
                *ngIf="
                  f['english_level'].hasError('min') ||
                  f['english_level'].hasError('max')
                "
              >
                English level must be between 1 and 10.
              </p>
            </td>
          </tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>
