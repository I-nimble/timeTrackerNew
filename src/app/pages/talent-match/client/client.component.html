<div class="row" *ngIf="userRole == '3'">
  <div class="col-12">
    <mat-card
      class="mat-card-top cardWithShadow position-relative overflow-hidden p-16"
    >
      <div class="d-flex row justify-content-between p-16">
        <div>
          <button
            mat-raised-button
            color="primary"
            (click)="goToCustomSearch()"
          >
            Custom Search
          </button>
        </div>
      </div>

      <div class="d-flex justify-content-center aling-items-center m-t-8">
        <img
          src="assets/images/talent-match.png"
          alt="Talent Match Logo"
          height="60"
        />
      </div>

      <div class="p-16">
        <h4 class="f-w-700 m-b-16">Main Filters</h4>
        <div class="row m-t-10">
          <div class="col-lg-6">
            <mat-label class="f-s-14 f-w-600 m-b-8 d-block">Role *</mat-label>
            <mat-form-field appearance="outline" class="w-100">
              <mat-select
                [(ngModel)]="selectedRole"
                name="selectedRole"
                #roleModel="ngModel"
                required
              >
                <mat-option
                  *ngFor="let role of positionsOptions"
                  [value]="role"
                >
                  {{ role }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="roleModel.invalid && roleModel.touched">
                Role is required.
              </mat-error>
            </mat-form-field>
            <mat-label class="f-s-14 f-w-600 m-b-8 d-block"
              >Practice Area *</mat-label
            >
            <mat-form-field appearance="outline" class="w-100">
              <mat-select
                [(ngModel)]="selectedPracticeArea"
                name="selectedPracticeArea"
                #practiceAreaModel="ngModel"
                required
              >
                <mat-option *ngFor="let area of practiceAreas" [value]="area">
                  {{ area }}
                </mat-option>
              </mat-select>
              <mat-error
                *ngIf="practiceAreaModel.invalid && practiceAreaModel.touched"
              >
                Practice Area is required.
              </mat-error>
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-label class="f-s-14 f-w-600 m-b-8 d-block"
              >Budget Range</mat-label
            >
            <div class="m-b-12">
              <!-- <mat-chip-listbox selectable>
                                <mat-chip-option
                                    *ngFor="let preset of budgetPresets"
                                    (click)="onPresetClick(preset)"
                                >
                                    {{ preset.label }}
                                </mat-chip-option>
                            </mat-chip-listbox> -->
            </div>
            <div class="d-flex align-items-center gap-3 m-b-16">
              <mat-slide-toggle (change)="toggleRateType()">
                {{ isMonthlyRate ? "Monthly (160 hrs)" : "Hourly" }}
              </mat-slide-toggle>
            </div>
            <ngx-slider
              [(value)]="budgetRange.min"
              [(highValue)]="budgetRange.max"
              [options]="budgetOptions"
              (userChangeEnd)="
                onBudgetChange({ min: budgetRange.min, max: budgetRange.max })
              "
            ></ngx-slider>
          </div>
        </div>
        <mat-accordion multi>
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>
                <h4 class="f-w-700">Advanced Filters</h4>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="row">
              <div class="col-lg-6">
                <mat-label class="f-s-14 f-w-600 m-b-8 d-block"
                  >Skills & Tools</mat-label
                >
                <mat-form-field appearance="outline" class="w-100">
                  <mat-select [(ngModel)]="selectedSkillsTools" multiple>
                    <mat-optgroup label="Skills">
                      <mat-option
                        *ngFor="let skill of skillsList"
                        [value]="skill"
                      >
                        {{ skill }}
                      </mat-option>
                    </mat-optgroup>
                    <mat-optgroup label="Tools">
                      <mat-option *ngFor="let tool of toolsList" [value]="tool">
                        {{ tool }}
                      </mat-option>
                    </mat-optgroup>
                  </mat-select>
                </mat-form-field>
                <mat-label class="f-s-14 f-w-600 m-b-8 d-block"
                  >Background</mat-label
                >
                <mat-form-field appearance="outline" class="w-100">
                  <mat-select [(ngModel)]="selectedBackground" multiple>
                    <mat-option
                      *ngFor="let bg of relatedBackgroundOptions"
                      [value]="bg"
                    >
                      {{ bg }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="col-lg-6">
                <mat-label class="f-s-14 f-w-600 m-b-8 d-block"
                  >Trainings</mat-label
                >
                <mat-form-field appearance="outline" class="w-100">
                  <mat-select [(ngModel)]="selectedCertifications" multiple>
                    <mat-option
                      *ngFor="let cert of certificationsOptions"
                      [value]="cert"
                    >
                      {{ cert }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
        <h4 class="f-w-700 m-b-16 m-t-16">
          Use AI to better describe the position
        </h4>
        <mat-form-field appearance="outline" class="w-100">
          <textarea
            matInput
            rows="4"
            placeholder="Tell us more about what you need for this role."
            [(ngModel)]="roleDescription"
            name="roleDescription"
            #roleDescModel="ngModel"
            maxlength="200"
          ></textarea>
          <mat-hint align="end"
            >{{ roleDescription?.length || 0 }}/200</mat-hint
          >
          <mat-error *ngIf="roleDescModel.errors?.['maxlength']">
            Maximum 200 characters allowed.
          </mat-error>
        </mat-form-field>
      </div>
      <div output>
        <div class="d-flex align-items-center gap-2 m-b-16 m-t-16">
          <app-match
            appearance="outline"
            class="flex-grow-1 hide-hint m-b-0"
            [loading]="aiLoading"
            [aiEnabled]="!useManualSearch"
            [canSearch]="canSearchAI"
            [showInterviewButton]="true"
            [interviewDisabled]="selection.selected.length === 0"
            [showCustomSearch]="!showCustomFilterInput"
            (interview)="openDialog('Schedule')"
            [query]="query"
            placeholder="What position are you looking for?"
            (askAI)="searchCandidatesWithAI($event)"
            (searchChange)="useManualSearch ? onManualSearch($event) : null"
          >
          </app-match>
        </div>
        <div *ngIf="aiLoading || aiAnswer" class="mt-16">
          <mat-card color="accent" class="p-16">
            <div>
              <ng-container *ngIf="aiLoading; else showTalentAnswer">
                <div class="d-flex align-items-center gap-8">
                  <img
                    src="assets/icons/ai-loader.gif"
                    alt="AI loading"
                    style="width: 80px; height: 80px"
                  />
                  <span>Matching with the ideal candidate...</span>
                </div>
              </ng-container>
              <ng-template #showTalentAnswer>
                <div [innerHTML]="aiAnswer || '' | markdown | linebreak"></div>
              </ng-template>
            </div>
          </mat-card>
        </div>
        <div
          class="table-responsive"
          *ngIf="dataSource?.data && dataSource.data.length > 0"
        >
          <table
            mat-table
            [dataSource]="dataSource"
            multiTemplateDataRows
            class="w-100"
          >
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef class="p-l-0">
                <mat-checkbox
                  (change)="$event ? masterToggleAndSyncSelection() : null"
                  [checked]="selection.hasValue() && isAllSelected()"
                  color="primary"
                  [indeterminate]="selection.hasValue() && !isAllSelected()"
                  [aria-label]="checkboxLabel()"
                >
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let row" class="p-l-0">
                <mat-checkbox
                  (click)="$event.stopPropagation()"
                  (change)="selection.toggle(row); onRowSelectionChange()"
                  color="primary"
                  [checked]="selection.isSelected(row)"
                  [aria-label]="checkboxLabel(row)"
                  *ngIf="!getInterviewDateTime(row.id)"
                >
                </mat-checkbox>
                <mat-checkbox
                  [checked]="true"
                  *ngIf="getInterviewDateTime(row.id)"
                  [disabled]="true"
                >
                </mat-checkbox>
              </td>
            </ng-container>

            <ng-container matColumnDef="name">
              <th
                mat-header-cell
                *matHeaderCellDef
                class="f-w-600 f-s-14 col-2"
              >
                Name
              </th>
              <td mat-cell *matCellDef="let element">
                <div class="d-flex align-items-center">
                  <img
                    [src]="
                      element.profile_pic_url
                        ? picturesUrl + '/' + element.profile_pic_url
                        : assetsPath
                    "
                    alt="users"
                    width="45"
                    height="45"
                    class="rounded-circle"
                    style="object-fit: cover; aspect-ratio: 1 / 1"
                    (error)="handleImageError($event)"
                  />
                  <div class="m-l-16">
                    <h6 class="f-s-14 f-w-600 cursor-pointer">
                      {{ element.name | formatName }}
                      <span class="disc-badges m-l-4">
                        <span
                          *ngFor="let profile of element.disc_profiles"
                          class="disc-badge-small"
                          [style.background-color]="
                            getDiscProfileColor(profile.name)
                          "
                          [title]="profile.name"
                        >
                          {{ profile.name.charAt(0) }}
                        </span>
                      </span>
                    </h6>
                    <span
                      class="f-s-12 f-w-400 d-block"
                      *ngIf="element.current_position"
                    >
                      {{ element.current_position }}
                    </span>
                  </div>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="position">
              <th
                mat-header-cell
                *matHeaderCellDef
                class="f-w-600 f-s-14 col-2"
              >
                Position
              </th>
              <td mat-cell *matCellDef="let element">
                <p class="f-s-14 f-s-12 m-0">
                  {{ getPositionTitle(element.position_id) }}
                </p>
                <span class="disc-badges">
                  <ng-container
                    *ngIf="getPositionById(element.position_id) as pos"
                  >
                    <span
                      *ngFor="let profile of pos.disc_profiles"
                      class="disc-badge-small"
                      [style.background-color]="
                        getDiscProfileColor(profile.name)
                      "
                      [title]="profile.name"
                    >
                      {{ profile.name.charAt(0) }}
                    </span>
                  </ng-container>
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="personality profile">
              <th
                mat-header-cell
                *matHeaderCellDef
                class="f-w-600 f-s-16 col-4"
              >
                Personality profile
              </th>
              <td mat-cell *matCellDef="let element">
                <span class="f-w-600"
                  >{{ element.match_percentage || "0" }}%
                </span>
                {{ element.position_category }}
              </td>
            </ng-container>

            <ng-container matColumnDef="trainings">
              <th
                mat-header-cell
                *matHeaderCellDef
                class="f-w-600 f-s-16 col-4"
              >
                Trainings
              </th>
              <td mat-cell *matCellDef="let element" class="f-s-14">
                <ng-container *ngIf="element.certifications && element.certifications.length > 0; else noCerts">
                  <div class="certifications-container">
                    <div *ngFor="let cert of element.certifications; let i = index" class="cert-item m-b-8">
                      <div *ngIf="cert.name" class="cert-name f-w-600 f-s-14 text-primary">
                        {{ cert.name }}
                      </div>
                      <div *ngIf="cert.issuer" class="cert-issuer f-s-12 text-muted">
                        Issuer: {{ cert.issuer }}
                      </div>
                      <div *ngIf="cert.date || cert.expiration_date" class="cert-dates f-s-12 text-muted">
                        <span *ngIf="cert.date">
                          {{ cert.date | date:'MMM yyyy' }}
                        </span>
                        <span *ngIf="cert.date && cert.expiration_date"> - </span>
                        <span *ngIf="cert.expiration_date">
                          {{ cert.expiration_date | date:'MMM yyyy' }}
                        </span>
                      </div>
                      <div *ngIf="cert.url" class="cert-link m-t-4">
                        <a
                          [href]="cert.url"
                          target="_blank"
                          mat-stroked-button
                          color="primary"
                          class="custom-btn"
                        >
                          See credential
                          <i-tabler
                            name="external-link"
                            class="icon-16 m-l-4"
                          ></i-tabler>
                        </a>
                      </div>
                    </div>
                  </div>
                </ng-container>
                
                <ng-template #noCerts>
                  <div class="text-muted f-s-14">
                    No trainings
                  </div>
                </ng-template>
              </td>
            </ng-container>

            <ng-container matColumnDef="rate">
              <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14">
                Rate
              </th>
              <td mat-cell *matCellDef="let element">
                <p class="f-s-14 m-0">
                  <span> $3 </span>
                </p>
              </td>
            </ng-container>

            <ng-container matColumnDef="expand">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let row">
                <button
                  mat-icon-button
                  (click)="
                    expandedElement = expandedElement === row ? null : row;
                    $event.stopPropagation()
                  "
                >
                  <mat-icon *ngIf="expandedElement !== row"
                    >keyboard_arrow_down</mat-icon
                  >
                  <mat-icon *ngIf="expandedElement === row"
                    >keyboard_arrow_up</mat-icon
                  >
                </button>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="f-w-600 f-s-14">
                Actions
              </th>
              <td mat-cell *matCellDef="let element">
                <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #actionsMenu="matMenu">
                  @if(getInterviewDateTime(element.id)) {
                  <button
                    mat-menu-item
                    (click)="openDialog('Reeschedule', element)"
                  >
                    <mat-icon>edit</mat-icon>
                    <span>Reeschedule</span>
                  </button>
                  <button mat-menu-item (click)="cancelInterview(element.id)">
                    <mat-icon>delete</mat-icon>
                    <span>Cancel Interview</span>
                  </button>
                  } @else {
                  <button
                    mat-menu-item
                    (click)="openDialog('Schedule', element)"
                  >
                    <mat-icon>event</mat-icon>
                    <span>Schedule</span>
                  </button>
                  }
                  <button
                    mat-menu-item
                    (click)="
                      downloadFile(element.resume_url, element.name);
                      $event.preventDefault()
                    "
                  >
                    <mat-icon>download</mat-icon>
                    <span>Download Resume</span>
                  </button>
                  <button mat-menu-item (click)="deleteApplication(element.id)">
                    <mat-icon>delete</mat-icon>
                    <span>Not interested</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>
            <ng-container matColumnDef="expandedDetail">
              <td
                mat-cell
                *matCellDef="let element"
                [attr.colspan]="displayedColumns.length + 1"
              >
                <div
                  class="expanded-detail-wrapper"
                  [@detailExpand]="
                    expandedElement === element ? 'expanded' : 'collapsed'
                  "
                >
                  <div class="expand-wrapper p-16">
                    <mat-card
                      class="shadow-none overflow-visible"
                    >
                      <div class="row align-items-center g-0 w-100">
  
                        <img src="https://inimble-app.s3.us-east-1.amazonaws.com/assets/images/inimble.png" class="logo-inimble" />
                        <div
                          class="col-12 d-flex flex-row align-items-center mb-16 mb-lg-0"
                        >
                        <div class="col-8 profile-info">
                            <h4 class="f-s-24 f-w-700 mt-2">
                              {{ element.name | formatName }}
                            </h4>
                            <p class="m-0 f-s-16 m-t-2">
                              This profile matches best for:
                            </p>
                            <p class="m-0 f-s-16 position-title m-t-16">
                              {{ getPositionTitle(element.position_id) }}
                            </p>
                          </div>
                          <div
                            class="profile-border-bg rounded-circle d-flex align-items-center justify-content-center col-4"
                          >
                            <div
                              class="profile-border rounded-circle d-flex align-items-center justify-content-center"
                              style="
                                width: 108px;
                                height: 108px;
                                border: 2px solid #ffffff;
                              "
                            >
                              <img
                                [src]="
                                  element.profile_pic_url
                                    ? picturesUrl +
                                      '/' +
                                      element.profile_pic_url
                                    : assetsPath
                                "
                                alt="users"
                                class="profile-pic rounded-circle"
                                style="
                                  width: 100%;
                                  height: 100%;
                                  object-fit: cover;
                                  aspect-ratio: 1 / 1;
                                "
                                (error)="handleImageError($event)"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    </mat-card>
                    <!-- Work Experience -->
                    <mat-card
                    class="shadow-none"
                    *ngIf="element.work_experience"
                    >
                    <mat-divider></mat-divider>
                    <mat-card-content>
                      <ng-container>
                          <h5 class="f-s-18 f-w-600 m-b-16 text-primary">Work Experience</h5>
                          <div>
                            <p>{{ element.work_experience }}</p>
                          </div>                       
                      </ng-container>
                    </mat-card-content>
                    </mat-card>
                    <!-- Skills - Hobbies -->
                    <mat-card
                    class="shadow-none"
                    *ngIf="element.skills || element.hobbies"
                    >
                    <mat-divider></mat-divider>
                    <mat-card-content class="d-flex row">
                      <div class="col-6 flex-column" *ngIf="element.skills">
                          <h5 class="f-s-18 f-w-600 m-b-16 text-primary">Skills</h5>
                          <div>
                            <p>{{ element.skills }}</p>
                          </div>                       
                      </div>
                       <div *ngIf="element.hobbies" class="col-6 hobbies">
                          <h5 class="f-s-18 f-w-600 m-b-16 text-primary">Hobbies</h5>
                          <div>
                            <p>{{ element.hobbies }}</p>
                          </div>                       
                      </div>
                      </mat-card-content>
                    </mat-card>
                    <!-- Education -->
                    <mat-card
                    class="shadow-none"
                    *ngIf="element.education_history"
                    >
                    <mat-divider></mat-divider>
                    <mat-card-content>
                      <ng-container>
                          <h5 class="f-s-18 f-w-600 m-b-16 text-primary">Education</h5>
                          <div>
                            <p>{{ element.education_history }}</p>
                          </div>                       
                      </ng-container>
                    </mat-card-content>
                    </mat-card>
                    <!-- Language -->
                    <mat-card class="shadow-none" *ngIf="element.english_level">
                    <mat-divider></mat-divider>
                    <mat-card-content>
                      <ng-container>
                        <h5 class="f-s-18 f-w-600 m-b-16 text-primary">Language</h5>
                        <div class="d-flex">
                          <div class="col-6">
                          <p class="f-s-16 f-w-600">English</p>
                          
                          <div class="progress-container m-t-8 m-b-8">
                            <div class="progress-bar-background">
                              <div 
                                class="progress-bar-fill"
                                [ngClass]="{
                                  'basic-level': element.english_level.toLowerCase() === 'basic',
                                  'intermediate-level': element.english_level.toLowerCase() === 'intermediate',
                                  'advanced-level': element.english_level.toLowerCase() === 'advanced'
                                }">
                              </div>
                              </div>
                              <div class="progress-labels">
                                <span>Basic</span>
                                <span>Intermediate</span>
                                <span>Advanced</span>
                              </div>
                            </div>
                          </div> 
                          <div class="col-6">
                            <p class="f-s-16 f-w-600">Spanish: Native</p>
                          </div>  
                        </div>                    
                      </ng-container>
                    </mat-card-content>
                  </mat-card>
                    <!-- Profile Summary -->
                    <mat-card
                    class="shadow-none"
                    *ngIf="element.talent_match_profile_summary"
                    >
                    <mat-divider></mat-divider>
                    <mat-card-content>
                      <ng-container>
                          <h5 class="f-s-18 f-w-600 m-b-16">Profile Summary</h5>
                          <div>
                            <p>{{ element.talent_match_profile_summary }}</p>
                          </div>                       
                      </ng-container>
                    </mat-card-content>
                    </mat-card>
                    <!-- Olympia -->
                    <mat-card class="shadow-none" *ngIf="element.all_match_scores && element.all_match_scores.length > 0">
                      <mat-divider></mat-divider>
                      <mat-card-content>
                        <ng-container>
                          <h5 class="f-s-18 f-w-600 m-b-16">What is it?</h5>
                          <p class="f-s-14 text-muted m-b-16">
                            Olympia is a personality-based analysis tool created by Inimble, designed specifically for legal roles. It translates behavioral patterns into key traits like precision, ethics, and emotional control to assess suitability in the legal fie
                          </p>
                          
                          <div *ngFor="let score of element.all_match_scores" class="match-score-item m-b-20">
                            <div class="d-flex justify-content-between align-items-center m-b-4">
                              <span class="f-s-16 f-w-500">{{ score.category_name }}</span>
                              <span class="f-s-16 f-w-600 text-primary">{{ score.match_percentage }}%</span>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="progress-container m-b-8">
                              <div class="progress-bar-background">
                                <div 
                                  class="progress-bar-fill"
                                  [ngClass]="{
                                    'low-match': score.match_percentage < 40,
                                    'medium-match': score.match_percentage >= 40 && score.match_percentage < 70,
                                    'high-match': score.match_percentage >= 70 && score.match_percentage < 90,
                                    'excellent-match': score.match_percentage >= 90
                                  }"
                                  [style.width.%]="score.match_percentage">
                                </div>
                              </div>
                              
                              <!-- Score Labels -->
                              <div class="progress-labels d-flex justify-content-between m-t-4">
                                <span class="f-s-12 text-muted">0%</span>
                                <span class="f-s-12 text-muted">50%</span>
                                <span class="f-s-12 text-muted">100%</span>
                              </div>
                            </div>
                          </div>
                          
                          <div class="m-t-24">
                            <p class="f-s-16 m-0 f-w-600">
                              Percentages are based on a 100% scale across all traits.
                            </p>
                          </div>
                        </ng-container>
                      </mat-card-content>
                    </mat-card>
                    <!-- Coworking location -->
                    <mat-card
                    class="shadow-none"
                    *ngIf="element.location"
                    >
                    <mat-divider></mat-divider>
                    <mat-card-content>
                      <ng-container>
                          <h5 class="f-s-18 f-w-600 m-b-16">Coworking location</h5>
                          <div>
                            {{ element.location }},  {{ element.country }}
                          </div>                       
                      </ng-container>
                    </mat-card-content>
                    </mat-card>
                  </div>
                </div>
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: columnsToDisplayWithExpand"
              (click)="onRowClick(row)"
              [class.disabled]="getInterviewDateTime(row.id)"
            ></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: ['expandedDetail']"
              class="expanded-detail-row"
              [class.expanded-visible]="expandedElement === row"
            ></tr>
            <tr *ngIf="dataSource?.data?.length === 0">
              <td colspan="8">
                <p>No candidates available.</p>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </mat-card>
  </div>
</div>
